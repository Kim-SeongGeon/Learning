# PART 1. 수학의 기초

## Chapter 3. 3D 강체 변환

### 3.1 회전 행렬

### 3.1.1 점, 벡터 및 좌표계

3차원 공간은 3개의 축으로 구성되므로 공간 점의 위치를 3개의 좌표로 지정할 수 있다. 그러나 이제 위치뿐만 아니라 자신의 자세를 가진 강체를 고려해야 한다. 카메라는 3차원 공간의 강체로 볼 수도 있으며 위치는 카메라가 공간에 있는 위치를 참조하고 자세는 카메라의 방향이다. 

가장 기본적인 점과 벡터부터 보면, 점은 공간의 기본 요소이며 길이가 없고 부피도 없다. 그리고 어떤 두 점을 연결하면 벡터가 형성된다. 벡터는 한 점에서 다른 점을 가리키는 화살표로 볼 수 있다. 벡터를 좌표의 개념과 혼동하지 않도록 주의해야 한다.

선형 대수학의 지식으로 3차원 공간의 점의 좌표는 $\mathbb{R}^3$에 의해 설명될 수 있다. 이 선형 공간에서 해당 공간의 기본 집합 즉, 베이스(base, 기본 집합은 영어로 base이고 공간에서 각각 선형 독립인 벡터의 집합이며, 일부 책은 orthogonal이라고도 한다) $(e_1, e_2, e_3)$ 을 찾았다고 가정하면 임의 벡터 $a$는 이 기본 집합으로 아래와 같이 표현할 수 있다.

$$a = [e_1, e_2, e_3] [a_1 a_2 a_3]^T = a_1e_1 + a_2e_2 + a_3e_3$$

여기서 $(a_1 a_2 a_3)^T$는 이 벡터 $a$의 좌표라고 한다. 좌표의 구체적인 값은 벡터 자체와 관련이 있으며 다른 하나는 좌표계(베이스)의 선택과 관련이 있다. 좌표계는 일반적으로 3개의 직교축으로 구성된다(직교가 아닌 축도 있을 수 있지만 실제로는 드물다). 예를 들어, $x$와 $y$축이 주어지면 $z$축은 오른쪽(또는 왼손) 법칙을 통해 $x$ x $y$로 정의할 수 있다. 정의 방법에 따라 좌표계는 왼손 법칙과 오른손 법칙으로 나뉘는데 왼손 법칙의 세 번째 축은 오른손 법칙과 반대 방향이다. 대부분의 3D 라이브러리는 오른손 법칙(예: OpenGL, 3D Max 등)을 사용하고 일부는 왼손 법칙(예: Unity, Direct3D 등)을 사용한다.

선형 대수학에 대한 기본 지식을 바탕으로 벡터와 벡터, 벡터와 숫자 사이의 연산(예: 스칼라곱, 벡터 덧셈과 뺄셈, 내적과 외적 등)에 대해 이야기할 수 있다. 스칼라곱, 벡터 덧셈과 뺄셈은 쉽게 알 수 있으므로 내적 및 외적에 대해 알아보면 $a, b \in \mathbb{R}^3$의 경우 일반적으로 의미(내적에도 더 일반적인 정의가 있지만 이 책에서는 일반적인 내적에 관해서만 설명한다.)의 내적을 다음과 같이 표현할 수 있다.

$$
a \cdot b = a^T b = \sum_{i=1}^{3} a_i b_i = |a||b|\cos \langle a,b \rangle
$$

$<a,b>$는 두 벡터 $a,b$ 사이의 각도이다. 내적은 벡터 간의 투영 관계를 설명할 수도 있다.  
반면 외적은 다음과 같다.

$$
a \times b = 
\begin{Vmatrix} 
e_1 & e_2 & e_3 \\ 
a_1 & a_2 & a_3 \\ 
b_1 & b_2 & b_3 
\end{Vmatrix} = 
\begin{bmatrix} 
a_2 b_3 - a_3 b_2 \\ 
a_3 b_1 - a_1 b_3 \\ 
a_1 b_2 - a_2 b_1 
\end{bmatrix} = 
\begin{bmatrix} 
0 & -a_3 & a_2 \\ 
a_3 & 0 & -a_1 \\ 
-a_2 & a_1 & 0 
\end{bmatrix} 
b \stackrel{\text{def}}{=} a^\wedge b
$$

외적의 결과는 벡터로 그 방향이 두 벡터에 수직이며 그 크기는 $|a||b|\sin \langle a,b \rangle$인데 두 벡터가 이루는 사변형의 넓이와 같다. 외적 연산의 경우 ^ 기호를 도입하여 표기하는데 이는 벡터 $a$가 skew-symmetric 행렬(skew-symmetric은 행렬 $A$가 $A^T = -A$를 충족한다는 것이다)을 이룬다는 의미이며 ^를 skew-symmetric 행렬 기호로 기억할 수 있겠다. 이렇게 하면 외적 $a x b$가 행렬과 벡터의 곱셈 $a^b$로 표기되며 이는 선형 연산이 된다. 이 기호는 나중에 자주 사용되며 이 기호는 모든 벡터가 고유한 반대 행렬이 존재하며 그 반대의 경우도 마찬가지임을 의미하는 일대일 매핑이다.

$$
a^\wedge = \begin{bmatrix} 
0 & -a_3 & a_2 \\ 
a_3 & 0 & -a_1 \\ 
-a_2 & a_1 & 0 
\end{bmatrix}
$$

### 3.1.2 좌표계 사이의 유클리드 변환

실제 장면에서는 다양한 좌표계를 정의하는 경우가 많다. 로봇 공학에서는 각 링크와 관절에 대한 좌표계를 각각 정의한다. 3차원 매핑에서는 직육면체와 실린더 좌표계로도 정의한다. 움직이는 로봇을 고려할 때 아래 그림의 $x_w, y_w, z_w$로 정의된 좌표계와 같이 고정된 것으로 간주할 수 있는 관성 좌표계(또는 표준 좌표계)를 설정하는 것이 일반적이다. 동시에 카메라 또는 로봇은 $x_C y_C z_C$로 정의된 좌표계와 같은 움직이는 좌표계이다. 카메라의 시야에서 점 $p$는 카메라 좌표계에서의 좌표가 $p_C$이고 표준 좌표계에서 볼 때 좌표는 $p_w$이다. 이 시점에서 두 좌표계 간의 변환은 어떻게 정의할 수 있을까? 카메라 좌표계에 대한 점의 좌푯값을 얻은 다음 카메라 자세에 따라 표준 좌표계로 변환해야 한다. 우리는 이 변환 관계를 설명하는 수학적 수단이 필요하며 나중에 행렬 $T$로 설명할 수 있음을 볼 수 있다.

<img src="Images/Coordinate Transformation.png" width="500"/>

직관적으로 알 수 있듯이 두 좌표계 사이의 모션은 회전과 병진(물체의 모든 부분이 같은 방향, 같은 속도로 이동)으로 구성되며, 이를 강체 변환이라고 하는데 당연하게도 카메라 모션은 강체 변환이다. 강체 변환 중에는 강체 내부의 동일한 벡터의 길이와 각도는 변경되지 않는다는 것이 강체의 정의이다. 강체 내점 사이의 길이나 각 면의 각도 등과 같은 특성이 변경되지 않고 공간 내에서의 위치와 자세만 달라질 수 있다. 휴대 전화를 바닥에 던지거나 잡아서 늘인다고 해서 고무처럼 줄어들지도 늘어나지도 않는 것과 같은 원리이다. 이 시점에서 우리는 휴대 전화 좌표계와 표준 좌표계 사이에는 유클리드 변환(Euclidean Transform)이 있다고 말한다.

유클리드 변환은 회전 및 병진으로 구성된다. 먼저 회전을 살펴보면, 단위 직교 기준 $(e_1, e_2, e_3)$을 한 번 회전하여 $(e_1', e_2', e_3'$로 바꾼다. 좌표계가 회전함에 따라(벡터 자체가 이동은 하지 않는다) 동일한 벡터 $a$의 두 좌표계 좌표는 $[a_1, a_2, a_3]^T$와 ${a_1', a_2', a_3'}^T$이며, 벡터 자체는 변경되지 않으므로 좌표의 정의에 따라 다음과 같이 표현할 수 있다.

$$
[e_1, e_2, e_3] 
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix} = 
[e_1', e_2', e_3'] 
\begin{bmatrix} 
a_1' \\ 
a_2' \\ 
a_3' 
\end{bmatrix}
$$

두 좌표 간의 관계를 설명하기 위해 위의 방정식의 왼쪽과 오른쪽에 $[e^T_1, e^T_2, e^T_3]^T$를 동시에 곱하면 왼쪽 계수가 단위행렬이 되므로 아래와 같이 식을 쓸 수 있다.

$$
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix} =
\begin{bmatrix} 
e^T_1e_1' & e^T_1e_2' & e^T_1e_3' \\ 
e^T_2e_1' & e^T_2e_2' & e^T_2e_3' \\ 
e^T_3e_1' & e^T_3e_2' & e^T_3e_3' 
\end{bmatrix}
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix}
\stackrel{\text{def}}{=}
Ra'
$$

중간 행렬을 행렬 $R$로 정의한다. 이 행렬은 두 좌표 세트의 기준 간의 내적으로 구성되며 회전 전후에 동일한 벡터의 좌표 관계를 묘사한다. 회전이 동일한 한 행렬 $R$은 동일하다. 행렬 $R$은 회전 자체를 설명한다고 말할 수 있으며, 이를 회전 행렬(Rotation Matrix)이라고 한다. 동시에 이 행렬의 구성 요소는 두 좌표계 기준(베이스)의 내적이며 기본 벡터는 길이가 1인 단위 벡터이기 때문에 실제로 각 기본 벡터 각도의 코사인값이다. 따라서 이 행렬을 방향 코사인 행렬(Direct Consine Matrix)이라고도 하며 회전 행렬과 동일하다.

회전 행렬에는 몇 가지 특별한 특성이 있다. 그것은 행렬식(determinant)이 1인 직교 행렬이라는 것이다. 다시 말하면 행렬식이 1인 직교 행렬 또한 회전 행렬이라는 것이다. 따라서 $n$차원 회전 행렬의 컬렉션을 다음과 같이 정의할 수 있다.

$$
\text{SO}(n) = {R \in \mathbb{R}^{n \times n} | RR^T = I, \det(R) = 1}
$$

$\text{SO}(n)$는 특수 직교 군(Special Orthogonal Group)을 뜻한다. 이 집합은 $n$차원 공간의 회전 행렬로 구성되며 특히 $\text{SO}(3)$는 3차원 공간의 회전을 의미한다. 행렬을 회전하면 베이시스 벡터에서 시작하는 대신 두 좌표계 간의 회전 변환에 대해 직접 이야기할 수 있다.

회전 행렬은 직교 행렬이므로 역(즉, 전치 또는 트랜스포즈, 직교 행렬은 역행렬이 전치행렬)은 반대 회전을 설명한다. 위의 정의에 따르면, 

$$
a' = R^{-1}a = R^Ta
$$

분명히 $R^T$는 회전 행렬의 역행렬과 동일하다.

유클리드 변환에서는 회전 외에도 병진이 있다. 표준 좌표계의 벡터 $a$를 고려하여 회전($R$로 설명됨)과 병진 $t$로 변환한 후 $a'$를 얻을 수 있는데 다음은 회전과 병진을 함께 표현한 것이다.

$$
a' = Ra + t
$$

여기서 $t$를 병진 벡터라고 한다. 병진 부분은 회전 후 좌표에 병진 벡터를 더하기만 하면 되므로 회전에 비해 매우 간단하다. 위의 방정식을 통해 회전 행렬 $R$과 병진 벡터 $t$를 사용한다면 유클리드 공간의 좌표 변환 관계를 완전히 설명할 수 있다. 실제로 좌표계 1과 좌표계 2를 정의하고 벡터 $a$의 좌표는 두 좌표계의 좌표이고 그 관계는 다음과 같아야 한다:

$$
a_1 = R_{12}a_2 + t_{12}
$$

여기서 $R_{12}$는 "좌표계 2의 벡터를 좌표계 1로 변환"을 의미한다(벡터는 행렬의 오른쪽에 곱해지므로 아래쪽 첨자면에서는 다양한 좌표계를 정의하는 경우가 많다. 로봇 공학에서는 각 링크와 관절에 대한 좌표계를 각각 정의한다. 3차원 매핑에서는 직육면체와 실린더 좌표계로도 정의한다. 움직이는 로봇을 고려할 때 아래 그림의 $x_w, y_w, z_w$로 정의된 좌표계와 같이 고정된 것으로 간주할 수 있는 관성 좌표계(또는 표준 좌표계)를 설정하는 것이 일반적이다. 동시에 카메라 또는 로봇은 $x_C y_C z_C$로 정의된 좌표계와 같은 움직이는 좌표계이다. 카메라의 시야에서 점 $p$는 카메라 좌표계에서의 좌표가 $p_C$이고 표준 좌표계에서 볼 때 좌표는 $p_w$이다. 이 시점에서 두 좌표계 간의 변환은 어떻게 정의할 수 있을까? 카메라 좌표계에 대한 점의 좌푯값을 얻은 다음 카메라 자세에 따라 표준 좌표계로 변환해야 한다. 우리는 이 변환 관계를 설명하는 수학적 수단이 필요하며 나중에 행렬 $T$로 설명할 수 있음을 볼 수 있다.

<img src="Images/Coordinate Transformation.png" width="500"/>

직관적으로 알 수 있듯이 두 좌표계 사이의 모션은 회전과 병진(물체의 모든 부분이 같은 방향, 같은 속도로 이동)으로 구성되며, 이를 강체 변환이라고 하는데 당연하게도 카메라 모션은 강체 변환이다. 강체 변환 중에는 강체 내부의 동일한 벡터의 길이와 각도는 변경되지 않는다는 것이 강체의 정의이다. 강체 내점 사이의 길이나 각 면의 각도 등과 같은 특성이 변경되지 않고 공간 내에서의 위치와 자세만 달라질 수 있다. 휴대 전화를 바닥에 던지거나 잡아서 늘인다고 해서 고무처럼 줄어들지도 늘어나지도 않는 것과 같은 원리이다. 이 시점에서 우리는 휴대 전화 좌표계와 표준 좌표계 사이에는 유클리드 변환(Euclidean Transform)이 있다고 말한다.

유클리드 변환은 회전 및 병진으로 구성된다. 먼저 회전을 살펴보면, 단위 직교 기준 $(e_1, e_2, e_3)$을 한 번 회전하여 $(e_1', e_2', e_3'$로 바꾼다. 좌표계가 회전함에 따라(벡터 자체가 이동은 하지 않는다) 동일한 벡터 $a$의 두 좌표계 좌표는 $[a_1, a_2, a_3]^T$와 ${a_1', a_2', a_3'}^T$이며, 벡터 자체는 변경되지 않으므로 좌표의 정의에 따라 다음과 같이 표현할 수 있다.

$$
[e_1, e_2, e_3] 
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix} = 
[e_1', e_2', e_3'] 
\begin{bmatrix} 
a_1' \\ 
a_2' \\ 
a_3' 
\end{bmatrix}
$$

두 좌표 간의 관계를 설명하기 위해 위의 방정식의 왼쪽과 오른쪽에 $[e^T_1, e^T_2, e^T_3]^T$를 동시에 곱하면 왼쪽 계수가 단위행렬이 되므로 아래와 같이 식을 쓸 수 있다.

$$
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix} =
\begin{bmatrix} 
e^T_1e_1' & e^T_1e_2' & e^T_1e_3' \\ 
e^T_2e_1' & e^T_2e_2' & e^T_2e_3' \\ 
e^T_3e_1' & e^T_3e_2' & e^T_3e_3' 
\end{bmatrix}
\begin{bmatrix} 
a_1 \\ 
a_2 \\ 
a_3 
\end{bmatrix}
\stackrel{\text{def}}{=}
Ra'
$$

중간 행렬을 행렬 $R$로 정의한다. 이 행렬은 두 좌표 세트의 기준 간의 내적으로 구성되며 회전 전후에 동일한 벡터의 좌표 관계를 묘사한다. 회전이 동일한 한 행렬 $R$은 동일하다. 행렬 $R$은 회전 자체를 설명한다고 말할 수 있으며, 이를 회전 행렬(Rotation Matrix)이라고 한다. 동시에 이 행렬의 구성 요소는 두 좌표계 기준(베이스)의 내적이며 기본 벡터는 길이가 1인 단위 벡터이기 때문에 실제로 각 기본 벡터 각도의 코사인값이다. 따라서 이 행렬을 방향 코사인 행렬(Direct Consine Matrix)이라고도 하며 회전 행렬과 동일하다.

회전 행렬에는 몇 가지 특별한 특성이 있다. 그것은 행렬식(determinant)이 1인 직교 행렬이라는 것이다. 다시 말하면 행렬식이 1인 직교 행렬 또한 회전 행렬이라는 것이다. 따라서 $n$차원 회전 행렬의 컬렉션을 다음과 같이 정의할 수 있다.

$$
\text{SO}(n) = {R \in \mathbb{R}^{n \times n} | RR^T = I, \det(R) = 1}
$$

$\text{SO}(n)$는 특수 직교 군(Special Orthogonal Group)을 뜻한다. 이 집합은 $n$차원 공간의 회전 행렬로 구성되며 특히 $\text{SO}(3)$는 3차원 공간의 회전을 의미한다. 행렬을 회전하면 베이시스 벡터에서 시작하는 대신 두 좌표계 간의 회전 변환에 대해 직접 이야기할 수 있다.

회전 행렬은 직교 행렬이므로 역(즉, 전치 또는 트랜스포즈, 직교 행렬은 역행렬이 전치행렬)은 반대 회전을 설명한다. 위의 정의에 따르면, 

$$
a' = R^{-1}a = R^Ta
$$

분명히 $R^T$는 회전 행렬의 역행렬과 동일하다.

유클리드 변환에서는 회전 외에도 병진이 있다. 표준 좌표계의 벡터 $a$를 고려하여 회전($R$로 설명됨)과 병진 $t$로 변환한 후 $a'$를 얻을 수 있는데 다음은 회전과 병진을 함께 표현한 것이다.

$$
a' = Ra + t
$$

여기서 $t$를 병진 벡터라고 한다. 병진 부분은 회전 후 좌표에 병진 벡터를 더하기만 하면 되므로 회전에 비해 매우 간단하다. 위의 방정식을 통해 회전 행렬 $R$과 병진 벡터 $t$를 사용한다면 유클리드 공간의 좌표 변환 관계를 완전히 설명할 수 있다. 실제로 좌표계 1과 좌표계 2를 정의하고 벡터 $a$의 좌표는 두 좌표계의 좌표이고 그 관계는 다음과 같아야 한다:

$$
a_1 = R_{12}a_2 + t_{12}
$$

여기서 $R_{12}$는 "좌표계 2의 벡터를 좌표계 1로 변환"을 의미한다(벡터는 행렬의 오른쪽에 곱해지므로 아래쪽 첨자는 오른쪽에서 왼쪽으로 읽는다).

변환 $t_{12}$의 경우 좌표계 1의 원점이 좌표계 2의 원점을 가리키는 벡터에 해당하며, 이는 좌표계 1에서 가져온 좌표이다. 그러나 $t_{21}$ 즉 좌표계 2에서 좌표계 1를 가리키는 벡터의 좌표는 $-t_{12}$와 같지 않지만 두 시스템의 회전과 관련이 있다. 따라서 "내 좌표가 어디에 있을까?"와 같은 질문을 할 때 이 문장의 의미를 명확하게 설명해야 하는데, 여기서 내 좌표는 실제로 표준 좌표계에서 자체 카메라 좌표계의 원점을 가리키는 벡터를 말하고, 이는 표준 좌표계에서 가져온 좌표이며, 수학 기호에 해당하는 값은 $t_{WC}$의 값이어야 한다. 마찬가지로 $t_{WC}$는 $-t_{WC}$와 같지 않다.

### 3.1.3 변환 행렬과 동차 좌표

$$
a' = Ra + t
$$

위의 식은 유클리드 공간의 회전 및 병진을 완전히 표현하지만 변환 관계가 선형 관계가 아니라는 작은 문제가 있다. $R_1$, $t_1$ 및 $R_2$, $t_2$의 두 가지 변환을 수행한다고 가정하면:

$$
b = R_1a + t_1,  c = R_2b + t_2.
$$

그런 다음 $a$에서 $c$로의 변환이 있다.

$$
c = R_2(R_1a+t_1)+t_2.
$$

이 형태는 위의 두 식을 합친 형태이다. 따라서 동차 좌표와 변환 행렬을 사용하여 다음과 같은 형태로 이 식 $a' = Ra + t$을 다시 작성할 수 있다:

$$
\begin{bmatrix} 
a' \\ 
1 
\end{bmatrix} = 
\begin{bmatrix} 
R & t \\ 
\mathbf{0}^T & 1 
\end{bmatrix} 
\begin{bmatrix} 
a \\ 
1 
\end{bmatrix} \stackrel{\text{def}}{=} T 
\begin{bmatrix} 
a \\ 
1 
\end{bmatrix}
$$

이것은 수학적 기법이다: 3차원 벡터의 끝에 1을 추가하여 동차 좌표라고 하는 4차원 벡터로 변환한다. 이 4차원 벡터의 경우 전체 관계를 선형 관계로 만드는 행렬에 회전 및 병진을 포함하여 작성할 수 있다. 이 경우 행렬 $T$를 변환 행렬(Transform Matrix)이라고 한다.

우리는 일시적으로 $\tilde{a}$로 $a$의 동차 좌표를 나타낸다고 하고, 그런 다음 좌표와 변환 행렬에 따라 두 변환의 결합이 다음과 같이 좋은 형태를 취할 수 있다:

$$
\tilde{b} = T_1 \tilde{a}, \quad \tilde{c} = T_2 \tilde{b} \quad \implies \tilde{c} = T_2 T_1 \tilde{a}
$$

그러나 벡터 끝에 1을 추가하거나 1을 제거하기만 하면 되므로 동차 좌표와 비동차 좌표를 구분하는 기호는 성가시다. 따라서 모호성을 일으키지 않도록 나중에 $b=Ta$로 직접 작성하고 기본적으로 필요한 경우 동차 좌표로 변환이 수행된다고 가정한다(동차 좌표 변환이 수행되지 않으면 행렬 차원에서 행렬의 곱셈이 의미가 없다).

변환 행렬 $T$의 경우 왼쪽 위 모서리는 회전 행렬, 오른쪽은 병진 벡터, 왼쪽 아래 모서리는 0벡터, 오른쪽 아래 모서리는 1이다. 이와 같은 행렬을 특수 유클리드 군(Special Euclidean Group)이라고도 하며 SE(3)으로 표기한다. 

$$
\text{SE}(3) = \left\{ T = \begin{bmatrix} R & t \\ \mathbf{0}^T & 1 \end{bmatrix} \in \mathbb{R}^{4 \times 4} \mid R \in \text{SO}(3), t \in \mathbb{R}^3 \right\}
$$

SO(3)와 마찬가지로 행렬의 역변환 표현을 해결하는 변환은 다음과 같다:

$$
T^{-1} = \begin{bmatrix} 
R^T & -R^T t \\ 
\mathbf{0}^T & 1 
\end{bmatrix}
$$

마찬가지로 $T_{12}$와 같은 표기법을 사용하여 2에서 1로의 변환을 나타낸다. 
